---
import { getCollection, render } from "astro:content";
import type { GetStaticPaths } from "astro";
import BaseLayout from "../../components/layout/BaseLayout.astro";

export const getStaticPaths = (async () => {
  const posts = await getCollection("blog", ({ data }) => {
    return import.meta.env.PROD ? !data.draft : true;
  });

  // Sort by date descending
  const sortedPosts = posts.sort(
    (a, b) => b.data.publishedAt.getTime() - a.data.publishedAt.getTime()
  );

  return sortedPosts.map((post, index) => ({
    params: { slug: post.data.slug || post.id },
    props: {
      post,
      prevPost: sortedPosts[index + 1] || null,  // older post
      nextPost: sortedPosts[index - 1] || null,  // newer post
      allPosts: sortedPosts,
    },
  }));
}) satisfies GetStaticPaths;

const { post, prevPost, nextPost, allPosts } = Astro.props;
const { Content, headings } = await render(post);

// Find related posts (same tags, excluding current post)
const currentTags = post.data.tags || [];
const relatedPosts = allPosts
  .filter((p) => {
    if (p.id === post.id) return false;
    const postTags = p.data.tags || [];
    return postTags.some((tag) => currentTags.includes(tag));
  })
  .slice(0, 3);

const formatDate = (date: Date) => {
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};

// Filter to only h2 and h3 for TOC
const tocHeadings = headings.filter(h => h.depth === 2 || h.depth === 3);
---

<BaseLayout
  title={post.data.title}
  description={post.data.description}
  image={`/og/blog/${post.id}.png`}
  type="article"
  publishedTime={post.data.publishedAt}
  modifiedTime={post.data.updatedAt}
>
  <article class="post">
    <header>
      <div class="metadata">
        <time datetime={post.data.publishedAt.toISOString()}>
          {formatDate(post.data.publishedAt)}
        </time>
      </div>
      <h1>{post.data.title}</h1>
      {post.data.description && (
        <p class="description">{post.data.description}</p>
      )}
      {post.data.tags && post.data.tags.length > 0 && (
        <div class="tags">
          {post.data.tags.map((tag) => (
            <a href={`/blog/tags/${encodeURIComponent(tag)}`} class="tag">{tag}</a>
          ))}
        </div>
      )}
    </header>

    {tocHeadings.length > 0 && (
      <nav class="toc">
        <h2>目錄</h2>
        <ul>
          {tocHeadings.map((heading) => (
            <li class={`toc-${heading.depth}`}>
              <a href={`#${heading.slug}`}>{heading.text}</a>
            </li>
          ))}
        </ul>
      </nav>
    )}

    <div class="content prose">
      <Content />
    </div>

    <!-- Post Navigation -->
    <nav class="post-nav">
      <div class="nav-item prev">
        {prevPost && (
          <a href={`/blog/${prevPost.data.slug || prevPost.id}`}>
            <span class="nav-label">← 上一篇</span>
            <span class="nav-title">{prevPost.data.title}</span>
          </a>
        )}
      </div>
      <div class="nav-item next">
        {nextPost && (
          <a href={`/blog/${nextPost.data.slug || nextPost.id}`}>
            <span class="nav-label">下一篇 →</span>
            <span class="nav-title">{nextPost.data.title}</span>
          </a>
        )}
      </div>
    </nav>

    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <section class="related-posts">
        <h2>相關文章</h2>
        <ul>
          {relatedPosts.map((relatedPost) => (
            <li>
              <a href={`/blog/${relatedPost.data.slug || relatedPost.id}`}>
                <span class="related-title">{relatedPost.data.title}</span>
                <span class="related-date">{formatDate(relatedPost.data.publishedAt)}</span>
              </a>
            </li>
          ))}
        </ul>
      </section>
    )}
  </article>
</BaseLayout>

<style>
  .post {
    margin-top: 2rem;
  }

  header {
    margin-bottom: 2rem;
  }

  .metadata {
    margin-bottom: 1rem;
  }

  time {
    color: var(--text-muted);
    font-size: var(--text-sm);
  }

  h1 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: var(--text-3xl);
    font-weight: 600;
    line-height: 1.3;
    letter-spacing: -0.03em;
  }

  .description {
    color: var(--text-muted);
    font-size: var(--text-base);
    line-height: 1.6;
    margin-bottom: 0;
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  .tag {
    font-size: var(--text-xs);
    color: var(--text-muted);
    text-decoration: none;
    padding: 0.25rem 0.75rem;
    background: var(--border-color);
    border-radius: 1rem;
    transition: all 0.2s;
  }

  .tag:hover {
    color: var(--link-color);
  }

  .tag::after {
    display: none;
  }

  /* TOC Styles */
  .toc {
    margin-bottom: 3rem;
    padding: 1.5rem;
    background: var(--bg-color-muted);
    border-radius: 0.5rem;
    border: 1px solid var(--border-color);
  }

  .toc h2 {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 1rem 0;
    padding: 0;
    border: none;
  }

  .toc ul {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .toc li {
    margin: 0;
    padding: 0;
  }

  .toc a {
    display: block;
    padding: 0.375rem 0;
    color: var(--text-color);
    text-decoration: none;
    font-size: var(--text-sm);
    transition: color 0.2s;
  }

  .toc a:hover {
    color: var(--link-color);
  }

  .toc a::after {
    display: none;
  }

  .toc .toc-3 {
    padding-left: 1rem;
  }

  .toc .toc-3 a {
    color: var(--text-muted);
    font-size: var(--text-xs);
  }

  /* Post Navigation */
  .post-nav {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 4rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border-color);
  }

  .nav-item a {
    display: block;
    padding: 1rem;
    background: var(--bg-color-muted);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    text-decoration: none;
    transition: border-color 0.2s;
  }

  .nav-item a:hover {
    border-color: var(--text-muted);
  }

  .nav-item a::after {
    display: none;
  }

  .nav-item.prev {
    text-align: left;
  }

  .nav-item.next {
    text-align: right;
  }

  .nav-label {
    display: block;
    font-size: var(--text-xs);
    color: var(--text-muted);
    margin-bottom: 0.25rem;
  }

  .nav-title {
    display: block;
    font-size: var(--text-sm);
    color: var(--text-color);
    font-weight: 500;
    line-height: 1.4;
  }

  /* Related Posts */
  .related-posts {
    margin-top: 3rem;
    padding: 1.5rem;
    background: var(--bg-color-muted);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
  }

  .related-posts h2 {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 1rem 0;
    padding: 0;
    border: none;
  }

  .related-posts ul {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .related-posts li {
    margin: 0;
    padding: 0;
  }

  .related-posts a {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 1rem;
    padding: 0.5rem 0;
    text-decoration: none;
    border-bottom: 1px solid var(--border-color);
  }

  .related-posts li:last-child a {
    border-bottom: none;
  }

  .related-posts a:hover .related-title {
    color: var(--link-color);
  }

  .related-posts a::after {
    display: none;
  }

  .related-title {
    font-size: var(--text-sm);
    color: var(--text-color);
    transition: color 0.2s;
  }

  .related-date {
    font-size: var(--text-xs);
    color: var(--text-muted);
    white-space: nowrap;
  }

  @media (max-width: 480px) {
    .post {
      margin-top: 1rem;
    }

    header {
      margin-bottom: 1.5rem;
    }

    h1 {
      font-size: var(--text-2xl);
    }

    .toc {
      padding: 1rem;
      margin-bottom: 2rem;
    }

    .post-nav {
      grid-template-columns: 1fr;
      margin-top: 3rem;
    }

    .nav-item.next {
      text-align: left;
    }

    .related-posts a {
      flex-direction: column;
      gap: 0.25rem;
    }

    .related-date {
      order: -1;
    }
  }
</style>
