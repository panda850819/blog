---
import { getCollection } from "astro:content";
import BaseLayout from "../../../components/layout/BaseLayout.astro";
import BaseHero from "../../../components/shared/BaseHero.astro";
import ArticleCard from "../../../components/ui/ArticleCard.astro";
import Container from "../../../components/ui/Container.astro";
import ContentList from "../../../components/shared/ContentList.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog", ({ data }) => {
    return import.meta.env.PROD ? !data.draft : true;
  });

  // 收集所有唯一的年份
  const years = new Set<number>();
  posts.forEach((post) => {
    years.add(post.data.publishedAt.getFullYear());
  });

  return [...years].map((year) => ({
    params: { year: String(year) },
    props: {
      year,
      posts: posts
        .filter((post) => post.data.publishedAt.getFullYear() === year)
        .sort((a, b) => b.data.publishedAt.getTime() - a.data.publishedAt.getTime()),
    },
  }));
}

const { year, posts } = Astro.props;
---

<BaseLayout title={`${year} 年文章`} description={`${year} 年發布的所有文章`}>
  <Container>
    <BaseHero title={`${year} 年`} description={`${posts.length} 篇文章`} />
    <div class="back-link">
      <a href="/blog/archive">← 所有年份</a>
    </div>
    <ContentList>
      {
        posts.map((post) => (
          <ArticleCard
            title={post.data.title}
            description={post.data.description}
            url={`/blog/${post.data.slug || post.id}`}
            date={post.data.publishedAt}
            tags={post.data.tags}
          />
        ))
      }
    </ContentList>
  </Container>
</BaseLayout>

<style>
  .back-link {
    margin-bottom: 2rem;
  }

  .back-link a {
    color: var(--muted-text-color);
    text-decoration: none;
    font-size: var(--text-sm);
  }

  .back-link a:hover {
    color: var(--link-color);
  }
</style>
