---
import { getCollection, render } from "astro:content";
import type { GetStaticPaths } from "astro";
import BaseLayout from "../../components/layout/BaseLayout.astro";

export const getStaticPaths = (async () => {
  const notes = await getCollection("notes");
  return notes.map((note) => ({
    params: { slug: note.id },
    props: { note },
  }));
}) satisfies GetStaticPaths;

const { note } = Astro.props;
const { Content, headings } = await render(note);

const formatDate = (date: Date) => {
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};

// Filter to only h2 and h3 for TOC
const tocHeadings = headings.filter(h => h.depth === 2 || h.depth === 3);
---

<BaseLayout title={note.data.title} description={note.data.description} image={`/og/notes/${note.id}.png`}>
  <article class="note">
    <header>
      <div class="metadata">
        <time datetime={note.data.publishedAt.toISOString()}>
          {formatDate(note.data.publishedAt)}
        </time>
        <a href={`/notes/${note.data.category}`} class="category">
          {note.data.category}
        </a>
      </div>
      <h1>{note.data.title}</h1>
      {note.data.description && (
        <p class="description">{note.data.description}</p>
      )}
    </header>

    {tocHeadings.length > 0 && (
      <nav class="toc">
        <h2>目錄</h2>
        <ul>
          {tocHeadings.map((heading) => (
            <li class={`toc-${heading.depth}`}>
              <a href={`#${heading.slug}`}>{heading.text}</a>
            </li>
          ))}
        </ul>
      </nav>
    )}

    <div class="content prose">
      <Content />
    </div>
  </article>
</BaseLayout>

<style>
  .note {
    margin-top: 2rem;
  }

  header {
    margin-bottom: 2rem;
  }

  .metadata {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1rem;
  }

  time {
    color: var(--text-muted);
    font-size: var(--text-sm);
  }

  .category {
    font-size: var(--text-xs);
    color: var(--text-muted);
    text-decoration: none;
    padding: 0.25rem 0.75rem;
    background: var(--border-color);
    border-radius: 1rem;
    transition: all 0.2s;
  }

  .category:hover {
    color: var(--link-color);
  }

  .category::after {
    display: none;
  }

  h1 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: var(--text-3xl);
    font-weight: 600;
    line-height: 1.3;
    letter-spacing: -0.03em;
  }

  .description {
    color: var(--text-muted);
    font-size: var(--text-base);
    line-height: 1.6;
    margin-bottom: 0;
  }

  /* TOC Styles */
  .toc {
    margin-bottom: 3rem;
    padding: 1.5rem;
    background: var(--bg-color-muted);
    border-radius: 0.5rem;
    border: 1px solid var(--border-color);
  }

  .toc h2 {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 1rem 0;
    padding: 0;
    border: none;
  }

  .toc ul {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .toc li {
    margin: 0;
    padding: 0;
  }

  .toc a {
    display: block;
    padding: 0.375rem 0;
    color: var(--text-color);
    text-decoration: none;
    font-size: var(--text-sm);
    transition: color 0.2s;
  }

  .toc a:hover {
    color: var(--link-color);
  }

  .toc a::after {
    display: none;
  }

  .toc .toc-3 {
    padding-left: 1rem;
  }

  .toc .toc-3 a {
    color: var(--text-muted);
    font-size: var(--text-xs);
  }

  @media (max-width: 480px) {
    .note {
      margin-top: 1rem;
    }

    header {
      margin-bottom: 1.5rem;
    }

    h1 {
      font-size: var(--text-2xl);
    }

    .toc {
      padding: 1rem;
      margin-bottom: 2rem;
    }
  }
</style>
