---
import { getCollection } from "astro:content";
import BaseLayout from "../components/layout/BaseLayout.astro";
import Container from "../components/ui/Container.astro";
import Section from "../components/ui/Section.astro";

const experiences = await getCollection("experience");

const formatDate = (date: Date | undefined) => {
  if (!date) return "";
  return date.toLocaleDateString("zh-TW", {
    year: "numeric",
    month: "short",
  });
};

const calculateDuration = (start: Date, end: Date | undefined, current: boolean) => {
  const endDate = current ? new Date() : end;
  if (!endDate) return "";

  const months = Math.round((endDate.getTime() - start.getTime()) / (1000 * 60 * 60 * 24 * 30.44));
  const years = Math.floor(months / 12);
  const remainingMonths = months % 12;

  if (years > 0 && remainingMonths > 0) {
    return `${years} 年 ${remainingMonths} 個月`;
  } else if (years > 0) {
    return `${years} 年`;
  } else {
    return `${remainingMonths} 個月`;
  }
};

// 排序：目前任職優先，其餘按開始日期由近到遠
const sortedExperiences = experiences.sort((a, b) => {
  if (a.data.current && !b.data.current) return -1;
  if (!a.data.current && b.data.current) return 1;
  return b.data.startDate.getTime() - a.data.startDate.getTime();
});
---

<BaseLayout title="工作經歷 - 熊貓隨口說" description="我的專業工作經歷">
  <Container>
    <Section>
      <h1>工作經歷</h1>
      <p class="subtitle">我的專業發展歷程</p>
      
      <div class="timeline">
        {sortedExperiences.map((exp, index) => (
          <article class="experience-card">
            <div class="timeline-marker">
              <div class="marker-dot"></div>
              {index < sortedExperiences.length - 1 && (
                <div class="marker-line"></div>
              )}
            </div>

            <div class="experience-content">
              <div class="experience-header">
                <div class="company-info">
                  <div>
                    <h2>{exp.data.title}</h2>
                    <p class="company-name">{exp.data.company}</p>
                    <div class="date-info">
                      <time>{formatDate(exp.data.startDate)} - {exp.data.current ? "至今" : formatDate(exp.data.endDate)}</time>
                      <span class="duration">· {calculateDuration(exp.data.startDate, exp.data.endDate, exp.data.current || false)}</span>
                    </div>
                  </div>
                </div>
                {exp.data.current && <span class="current-badge">目前任職</span>}
              </div>
              <p class="description">{exp.data.description}</p>
            </div>
          </article>
        ))}
      </div>

      {experiences.length === 0 && (
        <div class="empty-state">
          <p>目前還沒有工作經歷資料</p>
        </div>
      )}
    </Section>
  </Container>
</BaseLayout>

<style>
  h1 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }

  .subtitle {
    opacity: 0.7;
    margin-bottom: 3rem;
  }

  .timeline {
    position: relative;
  }

  .experience-card {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 2rem;
    position: relative;
  }

  .timeline-marker {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-shrink: 0;
  }

  .marker-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: currentColor;
    border: 2px solid currentColor;
    z-index: 1;
    margin-top: 0.75rem;
  }

  .marker-line {
    position: absolute;
    width: 2px;
    background: rgba(0, 0, 0, 0.08); /* 淺色模式線條 */
    top: calc(0.75rem + 12px);
    bottom: -2rem;
    left: 50%;
    transform: translateX(-50%);
  }

  [data-theme="dark"] .marker-line {
    background: rgba(255, 255, 255, 0.1);
  }

  .experience-content {
    flex: 1;
    padding-bottom: 0.5rem;
  }

  .experience-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }

  .company-info {
    display: flex;
    gap: 1.25rem;
    align-items: flex-start;
  }

  h2 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
  }

  .company-name {
    font-size: var(--text-xs);
    font-weight: 500;
    opacity: 0.7;
    margin: 0.25rem 0;
  }

  .date-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: var(--text-xs);
    opacity: 0.5;
  }

  .current-badge {
    padding: 0.2rem 0.6rem;
    background: rgba(34, 197, 94, 0.1);
    color: #16a34a;
    border-radius: 4px;
    font-size: 0.725rem;
    font-weight: 500;
  }

  [data-theme="dark"] .current-badge {
    background: rgba(74, 222, 128, 0.15);
    color: #4ade80;
  }

  .description {
    margin: 0.5rem 0 0 0;
    opacity: 0.7;
    line-height: 1.6;
    font-size: var(--text-sm);
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    opacity: 0.5;
  }

  @media (max-width: 640px) {
    h1 {
      font-size: 1.75rem;
    }

    .experience-card {
      gap: 1.25rem;
    }

    .company-info {
      gap: 1rem;
    }

    h2 {
      font-size: 1rem;
    }

    .date-info {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.125rem;
    }
  }
</style>
